<!-- audit-return.wxml - è¿˜è½¦å¾…å®¡æ ¸é¡µé¢ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ -->
<view class="audit-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>
  
  <!-- ä¸»è¦å†…å®¹ -->
  <view class="audit-content" wx:else>
    
    <!-- å‡ºè½¦è®°å½•åŸºæœ¬ä¿¡æ¯ -->
    <view class="record-info-card fade-in">
      <view class="card-title">ğŸ“‹ å‡ºè½¦è®°å½•ä¿¡æ¯</view>
      
      <!-- è½¦è¾†ä¿¡æ¯ -->
      <view class="vehicle-info">
        <view class="vehicle-text">
          <view class="vehicle-name">{{recordInfo.carModel}}</view>
          <view class="vehicle-number">{{recordInfo.carNumber}}</view>
        </view>
        <image class="vehicle-image" src="{{recordInfo.carImage}}" mode="aspectFit"></image>
      </view>
      
      <!-- è¯¦ç»†ä¿¡æ¯ç½‘æ ¼ -->
      <view class="info-grid">
        <view class="info-item">
          <view class="info-label">ç§Ÿèµäºº</view>
          <view class="info-value">{{recordInfo.renterName}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">è”ç³»æ–¹å¼</view>
          <view class="info-value phone" bindtap="makePhoneCall" data-phone="{{recordInfo.renterPhone}}">{{recordInfo.renterPhone}}</view>
        </view>
        <view class="info-item">
          <view class="info-label">ç§Ÿèµå¤©æ•°</view>
          <view class="info-value highlight">{{recordInfo.rentalDays}}å¤©</view>
        </view>
        <view class="info-item full-width">
          <view class="info-label">è®¡åˆ’è¿˜è½¦æ—¶é—´</view>
          <view class="info-value">{{recordInfo.plannedEndTime}}</view>
        </view>
      </view>
      
      <!-- è®¢å•é“¾æŠ˜å åŒºåŸŸ -->
      <view class="order-chain-section" wx:if="{{recordInfo.hasOrderChain}}">
        <!-- æŠ˜å å¤´éƒ¨ -->
        <view class="chain-header" catchtap="toggleOrderChain" data-record-id="{{recordInfo.id}}">
          <view class="chain-info">
            <text class="chain-icon">ğŸ”—</text>
            <text class="chain-title">è®¢å•é“¾è¯¦æƒ… ({{recordInfo.orderChainDetails.length}}ä¸ªè®¢å•)</text>
            <!-- ç»­ç§Ÿæ ‡ç­¾ -->
            <view wx:if="{{recordInfo.renewalCount > 0}}" class="renewal-badge">
              ç»­ç§Ÿ{{recordInfo.renewalCount}}æ¬¡
            </view>
          </view>
          <view class="chain-arrow" wx:if="{{isOrderChainExpanded}}">
            â–¼
          </view>
          <view class="chain-arrow" wx:else>
            â–¶
          </view>
        </view>
        
        <!-- æŠ˜å å†…å®¹ -->
        <view class="chain-content" wx:if="{{isOrderChainExpanded}}">
          
          <!-- è®¢å•é“¾æ¡åˆ—è¡¨ -->
          <view wx:for="{{recordInfo.orderChainDetails}}" wx:key="orderId" wx:for-item="chainItem" class="chain-item">
            
            <!-- è®¢å•ç±»å‹å’ŒçŠ¶æ€ -->
            <view class="chain-item-header">
              <view class="order-type-tag original" wx:if="{{chainItem.orderType === 'åŸè®¢å•'}}">
                {{chainItem.orderType}}
              </view>
              <view class="order-type-tag renewal" wx:else>
                {{chainItem.orderType}}
              </view>
              <view class="order-status-tag status-completed" wx:if="{{chainItem.orderStatus.includes('å·²å®Œæˆ')}}">
                {{chainItem.orderStatus}}
              </view>
              <view class="order-status-tag status-waiting" wx:elif="{{chainItem.orderStatus.includes('è¿˜è½¦å®¡æ ¸ä¸­')}}">
                {{chainItem.orderStatus}}
              </view>
              <view class="order-status-tag status-unknown" wx:else>
                {{chainItem.orderStatus}}
              </view>
            </view>
            
            <!-- è®¢å•è¯¦ç»†ä¿¡æ¯ -->
            <view class="chain-item-body">
              <view class="detail-row">
                <text class="detail-label">è®¢å•ç¼–å·</text>
                <text class="detail-value">{{chainItem.orderId}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">è®¢å•ä»·æ ¼</text>
                <text class="detail-value price-value">Â¥{{chainItem.price}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">ç”Ÿæ•ˆæ—¶é—´</text>
                <text class="detail-value">{{chainItem.startTime}} - {{chainItem.endTime}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">ç§ŸæœŸå¤©æ•°</text>
                <text class="detail-value">{{chainItem.rentalDays}}å¤©</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">åˆ›å»ºæ—¶é—´</text>
                <text class="detail-value">{{chainItem.createTime}}</text>
              </view>
              
              <!-- è¶…æ—¶ä¿¡æ¯ -->
              <block wx:if="{{chainItem.isOvertime}}">
                <view class="detail-row overtime-row">
                  <text class="detail-label">è¶…æ—¶æƒ…å†µ</text>
                  <text class="detail-value overtime-text">è¶…æ—¶{{chainItem.overtimeHours}}å°æ—¶</text>
                </view>
                <view class="detail-row" wx:if="{{chainItem.overtimeFee}}">
                  <text class="detail-label">è¶…æ—¶è´¹ç”¨</text>
                  <text class="detail-value overtime-fee">Â¥{{chainItem.overtimeFee}}</text>
                </view>
              </block>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ä»ªè¡¨ç›˜æ•°æ®å¯¹æ¯” -->
    <view class="dashboard-card fade-in">
      <view class="card-title">ğŸ“Š ä»ªè¡¨ç›˜æ•°æ®å¯¹æ¯”</view>
      
      <view class="dashboard-comparison">
        <!-- å‡ºè½¦æ—¶ä»ªè¡¨ç›˜ -->
        <view class="dashboard-item departure">
          <view class="dashboard-header">
            <view class="dashboard-title">ğŸš› å‡ºè½¦æ—¶</view>
            <view class="dashboard-actions">
              <button class="view-image-btn" bindtap="previewImages" data-type="departure" data-index="0">
                æŸ¥çœ‹å›¾ç‰‡
              </button>
            </view>
          </view>
          <view class="dashboard-value">{{dashboardData.departure.value}}h</view>
          <view class="dashboard-summary">
            1å¼ å›¾ç‰‡
          </view>
        </view>
        
        <!-- è¿˜è½¦æ—¶ä»ªè¡¨ç›˜ -->
        <view class="dashboard-item return" wx:if="{{modificationData.dashboardModified}}">
          <view class="dashboard-header">
            <view class="dashboard-title">ğŸ  è¿˜è½¦æ—¶</view>
            <view class="dashboard-actions">
              <button class="view-image-btn" bindtap="previewImages" data-type="return" data-index="0">
                æŸ¥çœ‹å›¾ç‰‡
              </button>
              <button class="modify-btn" bindtap="modifyDashboard">
                ä¿®æ”¹
              </button>
            </view>
          </view>
          
          <view class="dashboard-value">{{dashboardData.return.value}}h</view>
          <view class="dashboard-summary">
            1å¼ å›¾ç‰‡
          </view>
          
          <!-- ä¿®æ”¹åçš„æ•°æ®æ˜¾ç¤º -->
          <view class="modified-data">
            <view class="modified-label">ä¿®æ”¹åæ•°æ®ï¼š</view>
            <view class="modified-value">{{modificationData.newDashboardValue}}h</view>
          </view>
        </view>
        
        <!-- è¿˜è½¦æ—¶ä»ªè¡¨ç›˜ - æœªä¿®æ”¹çŠ¶æ€ -->
        <view class="dashboard-item return" wx:else>
          <view class="dashboard-header">
            <view class="dashboard-title">ğŸ  è¿˜è½¦æ—¶</view>
            <view class="dashboard-actions">
              <button class="view-image-btn" bindtap="previewImages" data-type="return" data-index="0">
                æŸ¥çœ‹å›¾ç‰‡
              </button>
              <button class="modify-btn" bindtap="modifyDashboard">
                ä¿®æ”¹
              </button>
            </view>
          </view>
          
          <view class="dashboard-value">{{dashboardData.return.value}}h</view>
          <view class="dashboard-summary">
            1å¼ å›¾ç‰‡
          </view>
        </view>
      </view>
    </view>
    
    <!-- è¿˜è½¦æ—¶é—´ -->
    <view class="return-time-card fade-in">
      <view class="card-title">â° ç”¨æˆ·è¿˜è½¦æ—¶é—´</view>
      
      <view class="time-display">
        <view class="time-info">
          <view class="time-label">åŸå§‹è¿˜è½¦æ—¶é—´</view>
          <view class="time-value">{{returnTime}}</view>
        </view>
        <button class="time-modify-btn" bindtap="modifyReturnTime">
          ä¿®æ”¹æ—¶é—´
        </button>
      </view>
      
      <!-- ä¿®æ”¹åçš„æ—¶é—´æ˜¾ç¤º -->
      <view class="modified-time-display" wx:if="{{modificationData.timeModified}}">
        <view class="time-info">
          <view class="time-label modified-label">ä¿®æ”¹åæ—¶é—´</view>
          <view class="time-value modified-value">{{modificationData.newReturnTime}}</view>
        </view>
      </view>
    </view>
    
    <!-- è¶…æ—¶è®¡ç®—ç»“æœ -->
    <view class="overtime-card fade-in">
      <view class="card-title">ğŸ“ˆ è¶…æ—¶è®¡ç®—ç»“æœ</view>
      
      <view class="overtime-result">
        
        <!-- ç”¨æˆ·æäº¤çš„è¿˜è½¦æ•°æ® -->
        <view class="calculation-section original-section">
          <view class="section-title">ğŸ‘¤ ç”¨æˆ·æäº¤çš„è¿˜è½¦æ•°æ®</view>
          <view class="calculation-item">
            <view class="calc-label">å·¥ä½œå°æ—¶æ•°</view>
            <view class="calc-value">{{originalOvertimeResult.calculation.workingHours}}å°æ—¶</view>
          </view>
          <view class="calculation-item">
            <view class="calc-label">è¶…æ—¶å¤©æ•°</view>
            <view class="calc-value">{{originalOvertimeResult.finalOvertime}}å¤©</view>
          </view>
          <block wx:if="{{originalOvertimeResult.finalOvertime > 0}}">
            <view class="calculation-item">
              <view class="calc-label">é€‰æ‹©çš„å•ä»·</view>
              <view class="calc-value price-value" wx:if="{{originalOvertimeResult.calculation.priceType === 'overtime'}}">
                Â¥{{originalOvertimeResult.calculation.selectedPrice}}/å°æ—¶
                (è¶…æ—¶å•ä»·)
              </view>
              <view class="calc-value price-value" wx:else>
                Â¥{{originalOvertimeResult.calculation.selectedPrice}}/å°æ—¶
                (ç»­ç§Ÿå•ä»·)
              </view>
            </view>
            <view class="calculation-item">
              <view class="calc-label">å·²æ”¯ä»˜è´¹ç”¨</view>
              <view class="calc-value price-value">Â¥{{originalOvertimeResult.totalFee}}</view>
            </view>
          </block>
        </view>
        
        <!-- å½“å‰è®¡ç®—ç»“æœï¼ˆåŒ…å«ä¿®æ”¹ï¼‰ -->
        <view class="calculation-section current-section" wx:if="{{showModificationSection}}">
          <view class="section-title">ğŸ”§ ç®¡ç†å‘˜ä¿®æ”¹åçš„è®¡ç®—ç»“æœ</view>
          
          <!-- å·¥ä½œå°æ—¶æ•°è®¡ç®— -->
          <view class="sub-section">
            <view class="sub-title">å·¥ä½œå°æ—¶æ•°æ£€æŸ¥</view>
            <view class="calculation-item">
              <view class="calc-label">ä¿®æ”¹åçš„å·¥ä½œå°æ—¶æ•°</view>
              <view class="calc-value">{{displayCurrentWorkingHours}}å°æ—¶</view>
            </view>
            <view class="calculation-item">
              <view class="calc-label">è´­ä¹°çš„å·¥ä½œå°æ—¶æ•°</view>
              <view class="calc-value">{{currentOvertimeResult.calculation.purchasedHours}}å°æ—¶</view>
            </view>
            <view class="calculation-item">
              <view class="calc-label">
                è¶…æ—¶å¤©æ•°
                <text class="help-icon" bindtap="showTooltip" data-type="working">?</text>
              </view>
              <view class="calc-value overtime" wx:if="{{currentOvertimeResult.calculation.workingOvertimeDays > 0}}">
                {{currentOvertimeResult.calculation.workingOvertimeDays}}å¤©
              </view>
              <view class="calc-value normal" wx:else>
                {{currentOvertimeResult.calculation.workingOvertimeDays}}å¤©
              </view>
            </view>
          </view>
          
          <!-- è¿˜è½¦æ—¶é—´è®¡ç®— -->
          <view class="sub-section">
            <view class="sub-title">è¿˜è½¦æ—¶é—´æ£€æŸ¥</view>
            <view class="calculation-item">
              <view class="calc-label">
                è¶…æ—¶å¤©æ•°
                <text class="help-icon" bindtap="showTooltip" data-type="time">?</text>
              </view>
              <view class="calc-value overtime" wx:if="{{currentOvertimeResult.calculation.timeOvertimeDays > 0}}">
                {{currentOvertimeResult.calculation.timeOvertimeDays}}å¤©
              </view>
              <view class="calc-value normal" wx:else>
                {{currentOvertimeResult.calculation.timeOvertimeDays}}å¤©
              </view>
            </view>
          </view>
          
          <!-- æœ€ç»ˆç»“æœå¯¹æ¯” -->
          <view class="comparison-result">
            <view class="result-item">
              <view class="result-label">
                æœ€ç»ˆçš„è¶…æ—¶å¤©æ•°
                <text class="help-icon" bindtap="showTooltip" data-type="final">?</text>
              </view>
              <view class="result-value">{{currentOvertimeResult.finalOvertime}}å¤©</view>
            </view>
            <view class="result-item">
              <view class="result-label">å·²æ”¯ä»˜çš„è¶…æ—¶å¤©æ•°</view>
              <view class="result-value">{{originalOvertimeResult.finalOvertime}}å¤©</view>
            </view>
            <view class="result-item">
              <view class="result-label">è¿˜éœ€æ”¯ä»˜çš„è¶…æ—¶å¤©æ•°</view>
              <view class="result-value">{{additionalOvertimeDays}}å¤©</view>
            </view>
          </view>
          
          <!-- ä»·æ ¼é€‰æ‹©åŒºåŸŸ -->
          <view class="price-options">
            <view class="price-option" wx:if="{{selectedPriceType === 'overtime'}}" bindtap="selectPriceType" data-type="overtime">
              <view class="price-type">è¶…æ—¶å•ä»·</view>
              <view class="price-calculation">
                <view>{{additionalOvertimeDays}}å¤© Ã— Â¥{{recordInfo.overtimePrice}}/å°æ—¶ Ã— 8å°æ—¶</view>
                <view class="price-total">= Â¥{{finalOvertimeFee}}</view>
              </view>
            </view>
            <view class="price-option selected" wx:else bindtap="selectPriceType" data-type="overtime">
              <view class="price-type">è¶…æ—¶å•ä»·</view>
              <view class="price-calculation">
                <view>{{additionalOvertimeDays}}å¤© Ã— Â¥{{recordInfo.overtimePrice}}/å°æ—¶ Ã— 8å°æ—¶</view>
                <view class="price-total">= Â¥{{finalOvertimeFee}}</view>
              </view>
            </view>
            <view class="price-option selected" wx:if="{{selectedPriceType === 'renewal'}}" bindtap="selectPriceType" data-type="renewal">
              <view class="price-type">ç»­ç§Ÿå•ä»·</view>
              <view class="price-calculation">
                <view>{{additionalOvertimeDays}}å¤© Ã— Â¥{{recordInfo.renewalPrice}}/å°æ—¶ Ã— 8å°æ—¶</view>
                <view class="price-total">= Â¥{{renewalFinalOvertimeFee}}</view>
              </view>
            </view>
            <view class="price-option" wx:else bindtap="selectPriceType" data-type="renewal">
              <view class="price-type">ç»­ç§Ÿå•ä»·</view>
              <view class="price-calculation">
                <view>{{additionalOvertimeDays}}å¤© Ã— Â¥{{recordInfo.renewalPrice}}/å°æ—¶ Ã— 8å°æ—¶</view>
                <view class="price-total">= Â¥{{renewalFinalOvertimeFee}}</view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- æ— ä¿®æ”¹æ—¶çš„ç®€å•æ˜¾ç¤º -->
        <view class="simple-result" wx:if="{{showSimpleResult}}">
          <view class="final-result">
            <block wx:if="{{originalOvertimeResult.finalOvertime > 0}}">
              <view class="final-overtime">ç”¨æˆ·è¶…æ—¶ {{originalOvertimeResult.finalOvertime}} å¤©</view>
              <view class="final-fee">å·²æ”¯ä»˜ï¼šÂ¥{{originalOvertimeResult.totalFee}}</view>
              <view style="font-size: 22rpx; color: #666; margin-top: 8rpx;">
                å•ä»·ï¼šÂ¥{{originalOvertimeResult.calculation.selectedPrice}}/å°æ—¶
              </view>
            </block>
            <block wx:else>
              <view class="no-overtime">âœ… ç”¨æˆ·æŒ‰æ—¶è¿˜è½¦ï¼Œæ— è¶…æ—¶</view>
            </block>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ä¿®æ”¹æé†’ -->
    <view class="warning-notice" wx:if="{{hasModification}}">
      <text class="warning-icon">âš ï¸</text>
      <view class="warning-text">
        æ‚¨å·²ä¿®æ”¹äº†è¿˜è½¦æ•°æ®ï¼Œæäº¤å®¡æ ¸åå°†é€šçŸ¥ç§Ÿèµäººç¡®è®¤ä¿®æ”¹å†…å®¹ã€‚è¯·ç¡®ä¿ä¸ç§Ÿèµäººæ²Ÿé€šä¸€è‡´åå†æäº¤ã€‚
      </view>
    </view>
    
  </view>
  
  <!-- ä»ªè¡¨ç›˜ä¿®æ”¹å¼¹çª— -->
  <view class="dashboard-modify-modal" wx:if="{{showDashboardModify}}" catchtap="closeDashboardModifyModal">
    <view class="modify-modal-content slide-up" catchtap="stopPropagation">
      <view class="modal-title">ä¿®æ”¹ä»ªè¡¨ç›˜æ•°æ®</view>
      
      <view class="modal-form">
        <view class="form-group">
          <label class="form-label">
            å®é™…ä»ªè¡¨ç›˜æ•°å€¼ï¼ˆå°æ—¶ï¼‰
            <text class="form-tip">æœ€å¤šä¿ç•™1ä½å°æ•°</text>
          </label>
          <input 
            class="form-input" 
            type="digit" 
            value="{{modificationData.newDashboardValue}}"
            bindinput="onDashboardInput"
            placeholder="è¯·è¾“å…¥å®é™…ä»ªè¡¨ç›˜æ•°å€¼"
            maxlength="10" />
          <view class="input-hint">
            åŸæ•°æ®ï¼š{{dashboardData.return.value}}h
          </view>
        </view>
        

        <view class="form-group">
          <label class="form-label">å®é™…ä»ªè¡¨ç›˜ç…§ç‰‡</label>
          <view class="image-upload-area">
            <view wx:for="{{modificationData.newDashboardImages}}" wx:key="*this" class="image-item">
              <image class="upload-image" src="{{item}}" mode="aspectFit"></image>
              <view class="delete-image" bindtap="deleteDashboardImage" data-index="{{index}}">Ã—</view>
            </view>
            <view class="upload-btn" bindtap="uploadDashboardImage" wx:if="{{modificationData.newDashboardImages.length < 5}}">
              +
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-actions">
        <button class="modal-btn cancel-btn" bindtap="closeDashboardModifyModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm-btn" bindtap="confirmDashboardModify">ç¡®è®¤ä¿®æ”¹</button>
      </view>
    </view>
  </view>
  
  <!-- æ—¶é—´é€‰æ‹©å™¨å¼¹çª— -->
  <view class="time-selector-modal" wx:if="{{showTimeSelector}}" catchtap="cancelTimeChange">
    <view class="time-selector-content slide-up" catchtap="stopPropagation">
      <view class="selector-title">ä¿®æ”¹è¿˜è½¦æ—¶é—´</view>
      
      <view class="selector-group">
        <view class="selector-label">æ—¥æœŸ</view>
        <picker 
          class="date-picker" 
          mode="date" 
          value="{{selectedDate}}" 
          bindchange="onDateChange">
          {{selectedDate}}
        </picker>
      </view>
      
      <view class="selector-group">
        <view class="selector-label">æ—¶é—´</view>
        <picker 
          class="time-picker" 
          mode="time" 
          value="{{selectedTime}}" 
          bindchange="onTimeChange">
          {{selectedTime}}
        </picker>
      </view>
      
      <view class="selector-actions">
        <view class="selector-btn cancel-btn" bindtap="cancelTimeChange">å–æ¶ˆ</view>
        <view class="selector-btn confirm-btn" bindtap="confirmTimeChange">ç¡®å®š</view>
      </view>
    </view>
  </view>
  
  <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
  <view class="image-preview-modal" wx:if="{{showImagePreview}}" catchtap="closeImagePreview">
    <view class="preview-header">
      <view class="preview-title">ä»ªè¡¨ç›˜å›¾ç‰‡</view>
      <view class="close-btn" bindtap="closeImagePreview">âœ•</view>
    </view>
    
    <view class="preview-content">
      <image class="preview-image" src="{{previewImage}}" mode="aspectFit" catchtap="stopPropagation"></image>
    </view>
  </view>
  
  <!-- è®¡ç®—è¯´æ˜å¼¹çª— -->
  <view class="tooltip-modal" wx:if="{{showTooltip}}" catchtap="closeTooltip">
    <view class="tooltip-content" catchtap="stopPropagation">
      <view class="tooltip-title">{{tooltipData.title}}</view>
      <view class="tooltip-text">{{tooltipData.content}}</view>
      <view class="tooltip-close">
        <button class="tooltip-btn" bindtap="closeTooltip">çŸ¥é“äº†</button>
      </view>
    </view>
  </view>
  
  <!-- å›ºå®šåº•éƒ¨å®¡æ ¸æŒ‰é’® -->
  <view class="fixed-bottom" wx:if="{{!loading}}">
    <button class="audit-submit-btn" bindtap="submitAudit" wx:if="{{hasModification}}">
      æäº¤ä¿®æ”¹å¹¶æ¨é€ç»™ç§Ÿèµäºº
    </button>
    <button class="audit-submit-btn" bindtap="submitAudit" wx:else>
      ç¡®è®¤å®¡æ ¸å®Œæ¯•
    </button>
  </view>
  
</view>