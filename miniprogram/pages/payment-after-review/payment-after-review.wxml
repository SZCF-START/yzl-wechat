<!-- payment-after-review.wxml - é‡‡ç”¨ç»­ç§Ÿé¡µé¢æ ·å¼å’Œè®¢å•é“¾æ”¯æŒ -->
<view class="payment-container">
  
  <!-- è®¢å•ä¿¡æ¯å¡ç‰‡ - é‡‡ç”¨ç»­ç§Ÿé¡µé¢æ ·å¼ -->
  <view class="order-card">
    <view class="info-header">
      <text class="info-title">è®¢å•ä¿¡æ¯</text>
      <text class="order-status completed">{{orderInfo.statusText || 'å·²å®Œæˆ'}}</text>
    </view>
    
    <!-- è½¦è¾†ä¿¡æ¯ -->
    <view class="car-info">
      <view class="car-name">{{orderInfo.carModel}}</view>
      <image class="car-image" src="{{orderInfo.carImage || '../../assets/rsg.png'}}" mode="aspectFit"></image>
    </view>
    
    <!-- é—¨åº—ä¿¡æ¯ -->
    <view class="store-info">
      <view class="store-point orange"></view>
      <view class="store-name">{{orderInfo.storeName}}</view>
    </view>
    <view class="store-info">
      <view class="store-point green"></view>
      <view class="store-name">{{orderInfo.returnStore || orderInfo.storeName}}</view>
    </view>
    
    <!-- ç§Ÿèµæ—¶é—´ -->
    <view class="rental-time">
      <view class="time-info">{{orderInfo.startTime}}</view>
      <view class="time-info">â€”</view>
      <view class="day-count">{{orderInfo.hasOrderChain ? orderInfo.totalRentalDays : orderInfo.rentalDays}}å¤©</view>
      <view class="time-info">â€”</view>
      <view class="time-info">{{orderInfo.endTime}}</view>
    </view>
    
    <!-- è®¢å•é“¾æŠ˜å åŒºåŸŸ - å§‹ç»ˆæ˜¾ç¤º -->
    <view class="order-chain-section">
      <!-- æŠ˜å å¤´éƒ¨ -->
      <view class="chain-header" catchtap="toggleOrderChain">
        <view class="chain-info">
          <text class="chain-icon">ğŸ”—</text>
          <text class="chain-title">è®¢å•é“¾è¯¦æƒ… ({{chainSummary.totalOrders}}ä¸ªè®¢å•)</text>
          <!-- ä½¿ç”¨é¢„è®¡ç®—çš„æ ‡ç­¾ -->
          <view wx:for="{{chainSummary.badges}}" wx:key="type" class="{{item.type}}-badge">
            {{item.text}}
          </view>
        </view>
        <view class="chain-arrow {{uiState.isChainExpanded ? 'expanded' : ''}}">
          â–¼
        </view>
      </view>
      
      <!-- æŠ˜å å†…å®¹ -->
      <view class="chain-content" wx:if="{{uiState.isChainExpanded}}">
        
        <!-- è®¢å•é“¾æ¡åˆ—è¡¨ -->
        <view wx:for="{{processedChainDetails}}" wx:key="orderId" wx:for-item="chainItem" class="chain-item">
          
          <!-- è®¢å•ç±»å‹å’ŒçŠ¶æ€ -->
          <view class="chain-item-header">
            <view class="order-type-tag {{chainItem.typeClassName}}">
              {{chainItem.orderType}}
            </view>
            <view class="order-status-tag {{chainItem.statusClassName}}">
              {{chainItem.orderStatus}}
            </view>
          </view>
          
          <!-- è®¢å•è¯¦ç»†ä¿¡æ¯ -->
          <view class="chain-item-body">
            <view class="detail-row">
              <text class="detail-label">è®¢å•ç¼–å·:</text>
              <text class="detail-value">{{chainItem.orderId}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">è®¢å•ä»·æ ¼:</text>
              <text class="detail-value price-value">{{chainItem.formattedPrice}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">ç”Ÿæ•ˆæ—¶é—´:</text>
              <text class="detail-value">{{chainItem.formattedEffectiveTime}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">ç§ŸæœŸå¤©æ•°:</text>
              <text class="detail-value">{{chainItem.rentalDays}}å¤©</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">åˆ›å»ºæ—¶é—´:</text>
              <text class="detail-value">{{chainItem.formattedCreateTime}}</text>
            </view>
            
            <!-- è¶…æ—¶ä¿¡æ¯ -->
            <block wx:if="{{chainItem.showOvertimeInfo}}">
              <view class="detail-row overtime-row">
                <text class="detail-label">è¶…æ—¶æƒ…å†µ:</text>
                <text class="detail-value overtime-text">è¶…æ—¶{{chainItem.overtimeHours}}å°æ—¶</text>
              </view>
              <view class="detail-row" wx:if="{{chainItem.actualEndTime}}">
                <text class="detail-label">å®é™…è¿˜è½¦:</text>
                <text class="detail-value">{{chainItem.actualEndTime}}</text>
              </view>
              <view class="detail-row" wx:if="{{chainItem.formattedOvertimeFee}}">
                <text class="detail-label">è¶…æ—¶è´¹ç”¨:</text>
                <text class="detail-value overtime-fee">{{chainItem.formattedOvertimeFee}}</text>
              </view>
              <!-- è¡¥ç¼´è®¢å•æ ‡è¯† -->
              <view class="payment-notice" wx:if="{{chainItem.showPaymentNotice}}">
                <text class="notice-icon">ğŸ’°</text>
                <text class="notice-text">æ­¤è®¢å•éœ€è¦è¡¥ç¼´è¶…æ—¶è´¹ç”¨</text>
              </view>
            </block>
          </view>
        </view>
        
        <!-- å‡ºè½¦è®°å½•ä¿¡æ¯ -->
        <view class="vehicle-record">
          <view class="record-header">
            <text class="record-icon">ğŸš—</text>
            <text class="record-title">å‡ºè½¦è®°å½•ä¿¡æ¯</text>
          </view>
          <view class="record-content">
            <view class="record-row">
              <text class="record-label">è®°å½•ç¼–å·:</text>
              <text class="record-value">{{orderInfo.vehicleRecordId}}</text>
            </view>
            <view class="record-row">
              <text class="record-label">è½¦è¾†ç¼–å·:</text>
              <text class="record-value">{{orderInfo.carNumber}}</text>
            </view>
            <view class="record-row">
              <text class="record-label">æ€»ç§ŸæœŸ:</text>
              <text class="record-value">{{orderInfo.hasOrderChain ? orderInfo.totalRentalDays : orderInfo.rentalDays}}å¤©</text>
            </view>
            <view class="record-row">
              <text class="record-label">ç»­ç§Ÿæ¬¡æ•°:</text>
              <text class="record-value">{{orderInfo.renewalCount || 0}}æ¬¡</text>
            </view>
            <view class="record-row">
              <text class="record-label">å–è½¦æ—¶é—´:</text>
              <text class="record-value">{{orderInfo.startTime}}</text>
            </view>
            <view class="record-row">
              <text class="record-label">è¿˜è½¦æ—¶é—´:</text>
              <text class="record-value">{{orderInfo.endTime}}</text>
            </view>
            <view class="record-row" wx:if="{{orderInfo.hasPayment}}">
              <text class="record-label">è¡¥ç¼´çŠ¶æ€:</text>
              <text class="record-value payment-status">å­˜åœ¨è¶…æ—¶è¡¥ç¼´è´¹ç”¨</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åŸºæœ¬è®¢å•ä¿¡æ¯ -->
    <view class="basic-info">
      <view class="info-row">
        <text class="info-label">è®¢å•ç¼–å·:</text>
        <text class="info-value">{{orderInfo.id}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">ç®¡ç†å‘˜:</text>
        <text class="info-value">{{orderInfo.managerName}}</text>
        <text class="phone-link" bindtap="makePhoneCall" data-phone="{{orderInfo.managerPhone}}">{{orderInfo.managerPhone}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">å‡ºè½¦è®°å½•:</text>
        <text class="info-value">{{orderInfo.vehicleRecordId}}</text>
      </view>
    </view>
  </view>

  <!-- ä»ªè¡¨ç›˜æ•°æ®å¯¹æ¯” -->
  <view class="dashboard-comparison">
    <!-- å‡ºè½¦æ—¶æ•°æ® -->
    <view class="info-card dashboard-card">
      <view class="card-header">
        <text class="card-title">å‡ºè½¦æ—¶ä»ªè¡¨ç›˜æ•°æ®</text>
      </view>
      <view class="dashboard-display initial">
        <text class="dashboard-value">{{orderInfo.initialHours}}</text>
        <text class="dashboard-unit">å°æ—¶</text>
      </view>
    </view>

    <!-- ç”¨æˆ·è¿˜è½¦æ•°æ® -->
    <view class="info-card dashboard-card">
      <view class="card-header">
        <text class="card-title">ç”¨æˆ·è¿˜è½¦æ—¶æ•°æ®</text>
      </view>
      <view class="dashboard-display user">
        <text class="dashboard-value">{{returnData.userReturnHours}}</text>
        <text class="dashboard-unit">å°æ—¶</text>
      </view>
    </view>
  </view>

  <!-- ç®¡ç†å‘˜å®¡æ ¸æ•°æ® -->
  <view class="info-card review-card">
    <view class="card-header">
      <text class="card-title">ç®¡ç†å‘˜å®¡æ ¸åä¿®æ”¹çš„æ•°æ®</text>
    </view>
    <view class="card-content">
      <view class="review-item">
        <text class="review-label">ä¿®æ”¹åä»ªè¡¨ç›˜æ•°æ®</text>
        <text class="review-value highlight">{{returnData.adminReturnHours}}å°æ—¶</text>
      </view>
      <view class="review-item">
        <text class="review-label">å®é™…è¿˜è½¦æ—¶é—´</text>
        <text class="review-value">{{returnData.actualReturnTime}}</text>
      </view>
      <view class="review-item">
        <text class="review-label">ä»ªè¡¨ç›˜ç…§ç‰‡</text>
      </view>
      <view class="dashboard-image-container">
        <image class="dashboard-image" src="{{returnData.dashboardImage}}" mode="aspectFill" />
      </view>
    </view>
  </view>

  <!-- è¶…æ—¶è®¡ç®—ç»“æœ -->
  <view class="info-card overtime-card">
    <view class="card-header">
      <text class="card-title">è¶…æ—¶è®¡ç®—ç»“æœ</text>
      <view class="question-btn" bindtap="showOvertimeDetail">
        <text class="question-icon">?</text>
      </view>
    </view>
    <view class="overtime-result">
      <text class="overtime-text">
        æœ€ç»ˆè¶…æ—¶äº† <text class="overtime-days">{{overtimeCalculation.finalOvertimeDays}}å¤©</text>
      </text>
    </view>
  </view>

  <!-- æ”¯ä»˜çŠ¶æ€ -->
  <view class="info-card payment-status-card">
    <view class="card-header">
      <text class="card-title">æ”¯ä»˜çŠ¶æ€</text>
    </view>
    <view class="card-content">
      <view class="payment-status-row">
        <text class="status-label">å·²æ”¯ä»˜è¶…æ—¶å¤©æ•°</text>
        <text class="status-value">{{overtimeCalculation.paidOvertimeDays}}å¤©</text>
      </view>
      <view class="payment-status-row highlight-row">
        <text class="status-label">å‰©ä½™éœ€æ”¯ä»˜å¤©æ•°</text>
        <text class="status-value highlight">{{overtimeCalculation.remainingOvertimeDays}}å¤©</text>
      </view>
    </view>
  </view>

  <!-- è®¡è´¹æ–¹å¼é€‰æ‹© -->
  <view class="info-card price-selection-card" wx:if="{{overtimeCalculation.remainingOvertimeDays > 0}}">
    <view class="card-header">
      <text class="card-title">é€‰æ‹©è®¡è´¹æ–¹å¼</text>
    </view>
    <view class="price-options">
      <view class="price-option {{priceOptions.selectedType === 'overtime' ? 'selected' : ''}}" 
            bindtap="selectPriceType" data-type="overtime">
        <view class="option-header">
          <text class="option-title">è¶…æ—¶å•ä»·</text>
          <view class="option-radio {{priceOptions.selectedType === 'overtime' ? 'checked' : ''}}"></view>
        </view>
        <view class="option-price">Â¥{{priceOptions.overtimePrice}}/å¤©</view>
        <view class="option-total">æ€»è®¡ï¼šÂ¥{{priceOptions.overtimeTotalPrice}}</view>
      </view>
      
      <view class="price-option {{priceOptions.selectedType === 'renewal' ? 'selected' : ''}}" 
            bindtap="selectPriceType" data-type="renewal">
        <view class="option-header">
          <text class="option-title">ç»­ç§Ÿå•ä»·</text>
          <view class="option-radio {{priceOptions.selectedType === 'renewal' ? 'checked' : ''}}"></view>
        </view>
        <view class="option-price">Â¥{{priceOptions.renewalPrice}}/å¤©</view>
        <view class="option-total">æ€»è®¡ï¼šÂ¥{{priceOptions.renewalTotalPrice}}</view>
      </view>
    </view>
  </view>

  <!-- æ— éœ€æ”¯ä»˜æç¤º -->
  <view class="info-card no-payment-card" wx:if="{{overtimeCalculation.remainingOvertimeDays <= 0}}">
    <view class="no-payment-content">
      <view class="no-payment-icon">âœ“</view>
      <text class="no-payment-title">æ— éœ€é¢å¤–æ”¯ä»˜</text>
      <text class="no-payment-desc">å·²æ”¯ä»˜é‡‘é¢å·²è¦†ç›–æ‰€æœ‰è¶…æ—¶è´¹ç”¨</text>
    </view>
  </view>

</view>

<!-- åº•éƒ¨æ“ä½œåŒºåŸŸ -->
<view class="bottom-actions">
  <!-- éœ€è¦æ”¯ä»˜æ—¶æ˜¾ç¤ºä»·æ ¼å’ŒæŒ‰é’® -->
  <view class="payment-action-row" wx:if="{{overtimeCalculation.remainingOvertimeDays > 0}}">
    <view class="payment-info-left">
      <text class="payment-label">éœ€è¦æ”¯ä»˜</text>
      <text class="payment-amount">Â¥{{priceOptions.finalPaymentAmount}}</text>
    </view>
    <button class="action-btn primary" 
            bindtap="submitPayment" 
            disabled="{{!uiState.canPayment || uiState.paymentProcessing}}">
      <text wx:if="{{uiState.paymentProcessing}}">æ”¯ä»˜ä¸­...</text>
      <text wx:else>ç«‹å³æ”¯ä»˜</text>
    </button>
  </view>
  
  <!-- æ— éœ€æ”¯ä»˜æ—¶æ˜¾ç¤ºå®ŒæˆæŒ‰é’® -->
  <button class="action-btn completed full-width" bindtap="goToComplete" wx:else>
    è®¢å•å·²å®Œæˆ
  </button>
</view>

<!-- è¶…æ—¶è¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay" wx:if="{{uiState.showOvertimeModal}}" bindtap="hideOvertimeDetail">
  <view class="modal-container" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è¶…æ—¶è®¡ç®—è¯¦æƒ…</text>
      <view class="modal-close" bindtap="hideOvertimeDetail">
        <text class="close-icon">Ã—</text>
      </view>
    </view>
    
    <view class="modal-content">
      <view class="detail-section">
        <view class="detail-title">ç§ŸæœŸæ—¶é—´è®¡ç®—</view>
        <text class="detail-text">{{overtimeCalculation.timeOvertimeDetail}}</text>
      </view>
      
      <view class="detail-section">
        <view class="detail-title">å·¥ä½œå°æ—¶æ•°è®¡ç®—</view>
        <text class="detail-text">{{overtimeCalculation.hoursOvertimeDetail}}</text>
      </view>
      
      <view class="detail-section">
        <view class="detail-title">æœ€ç»ˆè¶…æ—¶åŸå› </view>
        <text class="detail-text highlight">{{overtimeCalculation.finalOvertimeReason}}</text>
      </view>
    </view>
  </view>
</view>