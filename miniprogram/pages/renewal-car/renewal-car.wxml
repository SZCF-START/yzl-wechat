<!-- renewal-car.wxml - ä¿®æ”¹åæ”¯æŒè®¢å•å…³ç³»å±•ç¤ºçš„ç»­ç§Ÿé¡µé¢æ¨¡æ¿ -->
<view class="renew-container">
  
  <!-- æ–°å¢ï¼šè®¢å•å…³ç³»å±•ç¤º -->
  <view class="order-relationship" wx:if="{{showOrderChain}}">
    <view class="info-header">
      <text class="info-title">è®¢å•å…³ç³»</text>
    </view>
    <view class="relationship-content">
      <view class="current-order-info">
        <view class="order-chain-item main-order">
          <view class="order-tag">åŸè®¢å•</view>
          <view class="order-basic">
            <text class="order-id">{{originalOrderInfo.orderId}}</text>
            <text class="order-status completed">å·²å®Œæˆ</text>
          </view>
          <view class="order-period">
            <text class="period-text">{{originalStartTimeText}} - {{originalEndTimeText}}</text>
            <text class="period-days">({{originalOrderInfo.originalDays}}å¤©)</text>
          </view>
        </view>
        
        <!-- ç»­ç§Ÿé“¾æ˜¾ç¤º -->
        <view class="renewal-chain" wx:if="{{orderChainInfo.chainHistory.length > 1}}">
          <view wx:for="{{orderChainInfo.chainHistory}}" wx:key="orderId" wx:for-item="chainItem" wx:for-index="chainIndex" class="order-chain-item renewal-order">
            <view class="order-tag renewal">ç»­ç§Ÿ{{chainIndex + 1}}</view>
            <view class="order-basic">
              <text class="order-id">{{chainItem.orderId}}</text>
              <text class="order-status {{chainItem.status === 'å·²å®Œæˆ' ? 'completed' : 'pending'}}">{{chainItem.status}}</text>
            </view>
            <view class="order-period">
              <text class="period-days">({{chainItem.days}}å¤©)</text>
            </view>
          </view>
        </view>
        
        <!-- æ–°ç»­ç§Ÿè®¢å•é¢„è§ˆ -->
        <view class="order-chain-item new-renewal">
          <view class="order-tag new">æ–°ç»­ç§Ÿ</view>
          <view class="order-basic">
            <text class="order-id">{{renewalOrderInfo.orderId}}</text>
            <text class="order-status pending">å¾…åˆ›å»º</text>
          </view>
          <view class="order-period">
            <text class="period-text" wx:if="{{renewDays}}">ç»­ç§Ÿ{{renewDays}}å¤©</text>
            <text class="period-text" wx:else>ç­‰å¾…è®¾ç½®</text>
          </view>
        </view>
      </view>
      
      <!-- å…³ç³»è¯´æ˜ -->
      <view class="relationship-note">
        <view class="note-item">
          <text class="note-icon">ğŸ”—</text>
          <text class="note-text">ç»­ç§Ÿè®¢å•å°†ä¸åŸè®¢å•å…³è”ï¼Œå…±äº«åŒä¸€å‡ºè½¦è®°å½•</text>
        </view>
        <view class="note-item">
          <text class="note-icon">â°</text>
          <text class="note-text">ç»­ç§Ÿè®¢å•åœ¨åŸè®¢å•ç»“æŸåè‡ªåŠ¨ç”Ÿæ•ˆ</text>
        </view>
        <view class="note-item">
          <text class="note-icon">ğŸš—</text>
          <text class="note-text">è½¦è¾†æ— éœ€é‡æ–°å–è½¦ï¼Œä¿æŒè¿ç»­ä½¿ç”¨</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŸè®¢å•ä¿¡æ¯ -->
  <view class="order-info">
    <view class="info-header">
      <text class="info-title">åŸè®¢å•ä¿¡æ¯</text>
      <text class="info-subtitle">(å·²å®Œæˆ)</text>
    </view>
    <view class="info-row">
      <text class="info-label">è®¢å•ç¼–å·ï¼š</text>
      <text class="info-value">{{originalOrderInfo.orderId}}</text>
    </view>
    <view class="info-row">
      <text class="info-label">é—¨åº—åç§°ï¼š</text>
      <text class="info-value">{{originalOrderInfo.storeName}}</text>
    </view>
    <view class="info-row">
      <text class="info-label">ç®¡ç†å‘˜ï¼š</text>
      <text class="info-value">{{originalOrderInfo.managerName}}</text>
      <text class="phone-link" bindtap="makePhoneCall" data-phone="{{originalOrderInfo.managerPhone}}">{{originalOrderInfo.managerPhone}}</text>
    </view>
    <view class="info-row">
      <text class="info-label">è½¦å‹åç§°ï¼š</text>
      <text class="info-value">{{originalOrderInfo.carModel}}</text>
    </view>
    <view class="info-row">
      <text class="info-label">åŸç§ŸæœŸï¼š</text>
      <text class="info-value">{{originalStartTimeText}} â€”â€” {{originalEndTimeText}}</text>
    </view>
    <view class="info-row">
      <text class="info-label">åŸç§Ÿå¤©æ•°ï¼š</text>
      <text class="info-value highlight">{{originalOrderInfo.originalDays}}å¤©</text>
    </view>
    <view class="info-row">
      <text class="info-label">å‡ºè½¦è®°å½•ï¼š</text>
      <text class="info-value">{{originalOrderInfo.vehicleRecordId}}</text>
    </view>
  </view>

  <!-- ä¼šå‘˜è´­ä¹°å¡ç‰‡ -->
  <view class="member-card" wx:if="{{showMemberCard}}">
    <view class="info-header">
      <text class="info-title">ä¼šå‘˜ç‰¹æƒ</text>
    </view>
    <view class="member-content">
      <view class="member-benefits">
        <view class="benefit-item">
          <text class="benefit-icon">ğŸ‰</text>
          <text class="benefit-text">ç»­ç§Ÿäº«å—{{membershipInfo.discountText}}ä¼˜æƒ </text>
        </view>
        <view class="benefit-item">
          <text class="benefit-icon">âš¡</text>
          <text class="benefit-text">ä¸“å±å®¢æœä¼˜å…ˆæœåŠ¡</text>
        </view>
        <view class="benefit-item">
          <text class="benefit-icon">ğŸ”§</text>
          <text class="benefit-text">å…è´¹è®¾å¤‡æ£€æµ‹æœåŠ¡</text>
        </view>
      </view>
      <view class="member-purchase">
        <view class="purchase-option">
          <checkbox-group bindchange="onPurchaseMembershipChange">
            <label class="checkbox-label">
              <checkbox value="purchase" checked="{{purchaseMembership}}" color="#ff7200"/>
              <text class="purchase-text">è´­ä¹°ä¼šå‘˜</text>
              <text class="member-price">Â¥{{membershipInfo.price}}</text>
            </label>
          </checkbox-group>
        </view>
        <view class="member-tip">
          <text class="tip-text">æœ¬æ¬¡ç»­ç§Ÿç«‹å³äº«å—ä¼šå‘˜ä»·æ ¼</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç»­ç§Ÿè®¾ç½® -->
  <view class="renew-section">
    <view class="info-header">
      <text class="info-title">æ–°ç»­ç§Ÿè®¢å•è®¾ç½®</text>
    </view>
    
    <!-- æ–°è®¢å•ä¿¡æ¯é¢„è§ˆ -->
    <view class="new-order-preview">
      <view class="preview-row">
        <text class="preview-label">æ–°è®¢å•ç¼–å·ï¼š</text>
        <text class="preview-value">{{renewalOrderInfo.orderId}}</text>
      </view>
      <view class="preview-row">
        <text class="preview-label">å…³è”åŸè®¢å•ï¼š</text>
        <text class="preview-value">{{renewalOrderInfo.parentOrderId}}</text>
      </view>
      <view class="preview-row">
        <text class="preview-label">ç»­ç§Ÿå±‚çº§ï¼š</text>
        <text class="preview-value">ç¬¬{{renewalOrderInfo.renewalLevel}}æ¬¡ç»­ç§Ÿ</text>
      </view>
      <view class="preview-row">
        <text class="preview-label">å‡ºè½¦è®°å½•ï¼š</text>
        <text class="preview-value">{{originalOrderInfo.vehicleRecordId}} (å…±äº«)</text>
      </view>
    </view>
    
    <view class="renew-input-row">
      <text class="input-label">ç»­ç§Ÿå¤©æ•°ï¼š</text>
      <input 
        class="day-input" 
        type="number" 
        placeholder="è¯·è¾“å…¥ç»­ç§Ÿå¤©æ•°"
        value="{{renewDays}}"
        bindinput="onRenewDaysChange"
        bindblur="onRenewDaysBlur"
        min="1"
      />
      <text class="input-unit">å¤©</text>
    </view>
    <view class="input-tip">*æœ€å°‘ç»­ç§Ÿ1å¤©ï¼Œç»­ç§Ÿè®¢å•å°†åœ¨åŸè®¢å•ç»“æŸåè‡ªåŠ¨ç”Ÿæ•ˆ</view>
    <view class="error-tip" wx:if="{{daysErrorTip}}">
      <text class="error-text">{{daysErrorTip}}</text>
    </view>
    
    <!-- æ–°ç§ŸæœŸæ˜¾ç¤º -->
    <view class="new-period" wx:if="{{showNewPeriod}}">
      <view class="period-header">
        <text class="period-title">æ–°ç»­ç§Ÿè®¢å•ç§ŸæœŸ</text>
        <text class="period-status">å¾…ç”Ÿæ•ˆ</text>
      </view>
      <view class="period-display">
        <text class="period-text">{{newStartTime}} â€”â€” {{newEndTime}}</text>
        <text class="period-days">(ç»­ç§Ÿ{{renewDays}}å¤©)</text>
      </view>
      <view class="period-note">
        <text class="note-text">æ³¨ï¼šç»­ç§Ÿè®¢å•å°†åœ¨{{originalEndTimeText}}åŸè®¢å•ç»“æŸåç«‹å³ç”Ÿæ•ˆ</text>
      </view>
    </view>
  </view>

  <!-- æ”¯ä»˜æ˜ç»† -->
  <view class="payment-detail" wx:if="{{showPaymentDetail}}">
    <view class="info-header">
      <text class="info-title">æ”¯ä»˜æ˜ç»† (æ–°ç»­ç§Ÿè®¢å•)</text>
    </view>
    <view class="detail-row">
      <text class="detail-label">ç»­ç§Ÿå¤©æ•°ï¼š</text>
      <text class="detail-value">{{renewDays}}å¤©</text>
    </view>
    <view class="detail-row">
      <text class="detail-label">ç»­ç§Ÿå•ä»·ï¼š</text>
      <text class="detail-value">
        Â¥{{currentRenewPrice}}/å¤©
        <text class="original-price" wx:if="{{(isMember || purchaseMembership) && currentRenewPrice != renewPrice}}">
          åŸä»·Â¥{{renewPrice}}
        </text>
      </text>
    </view>
    <view class="detail-row">
      <text class="detail-label">ç»­ç§Ÿå°è®¡ï¼š</text>
      <text class="detail-value">Â¥{{renewSubtotal}}</text>
    </view>
    
    <!-- ä¼šå‘˜è´¹ç”¨ -->
    <view class="detail-row" wx:if="{{purchaseMembership && membershipFee > 0}}">
      <text class="detail-label">ä¼šå‘˜è´¹ç”¨ï¼š</text>
      <text class="detail-value member-fee">Â¥{{membershipFee}}</text>
    </view>
    
    <view class="detail-row subtotal-row">
      <text class="detail-label">æœåŠ¡è´¹å‰å°è®¡ï¼š</text>
      <text class="detail-value">Â¥{{serviceSubtotal}}</text>
    </view>
    
    <!-- ç³»ç»ŸæœåŠ¡è´¹ -->
    <view class="detail-row">
      <text class="detail-label">ç³»ç»ŸæœåŠ¡è´¹({{serviceRatePercent}}%)ï¼š</text>
      <text class="detail-value service-fee">Â¥{{serviceFee}}</text>
    </view>
    
    <view class="detail-row total-row">
      <text class="detail-label">æ€»è®¡ï¼š</text>
      <text class="detail-value total-price">Â¥{{totalAmount}}</text>
    </view>
    
    <!-- è®¢å•åˆ›å»ºè¯´æ˜ -->
    <view class="payment-note">
      <view class="note-header">ğŸ“‹ è®¢å•åˆ›å»ºè¯´æ˜</view>
      <view class="note-content">
        <text class="note-item">â€¢ æ”¯ä»˜æˆåŠŸåå°†ç«‹å³åˆ›å»ºæ–°çš„ç»­ç§Ÿè®¢å•</text>
        <text class="note-item">â€¢ ç»­ç§Ÿè®¢å•çŠ¶æ€ä¸º"å¾…ç”Ÿæ•ˆ"ï¼Œåœ¨åŸè®¢å•ç»“æŸåè‡ªåŠ¨ç”Ÿæ•ˆ</text>
        <text class="note-item">â€¢ æ–°è®¢å•ä¸åŸè®¢å•å…±äº«åŒä¸€å‡ºè½¦è®°å½•ï¼Œè½¦è¾†æ— éœ€é‡æ–°å–è½¦</text>
        <text class="note-item">â€¢ ç»­ç§Ÿè®¢å•å¯ä»¥ç»§ç»­è¿›è¡Œç»­ç§Ÿæˆ–è¿˜è½¦æ“ä½œ</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ”¯ä»˜åŒºåŸŸ -->
  <view class="payment-section">
    <view class="payment-left">
      <text class="payment-label">åˆ›å»ºç»­ç§Ÿè®¢å•å¹¶æ”¯ä»˜ï¼š</text>
      <text class="payment-amount">Â¥{{totalAmount || '0.00'}}</text>
    </view>
    <button class="payment-btn" bindtap="submitPayment" disabled="{{!canPay}}">
      {{paymentButtonText}}
    </button>
  </view>
</view>

<!-- æ”¯ä»˜ç¡®è®¤å¼¹çª— -->
<view class="modal-mask" wx:if="{{showPaymentModal}}" bindtap="hidePaymentModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç¡®è®¤åˆ›å»ºç»­ç§Ÿè®¢å•</text>
      <text class="modal-close" bindtap="hidePaymentModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="confirm-detail">
        <view class="confirm-section">
          <text class="section-title">ç»­ç§Ÿè®¢å•ä¿¡æ¯</text>
          <view class="confirm-row">
            <text class="confirm-label">æ–°è®¢å•ç¼–å·ï¼š</text>
            <text class="confirm-value">{{renewalOrderInfo.orderId}}</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">å…³è”åŸè®¢å•ï¼š</text>
            <text class="confirm-value">{{renewalOrderInfo.parentOrderId}}</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§Ÿå±‚çº§ï¼š</text>
            <text class="confirm-value">ç¬¬{{renewalOrderInfo.renewalLevel}}æ¬¡ç»­ç§Ÿ</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">è®¢å•çŠ¶æ€ï¼š</text>
            <text class="confirm-value">å¾…ç”Ÿæ•ˆ (åŸè®¢å•ç»“æŸåè‡ªåŠ¨ç”Ÿæ•ˆ)</text>
          </view>
        </view>
        
        <view class="confirm-section">
          <text class="section-title">ç§ŸæœŸä¿¡æ¯</text>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§Ÿå¤©æ•°ï¼š</text>
            <text class="confirm-value">{{renewDays}}å¤©</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§ŸæœŸé—´ï¼š</text>
            <text class="confirm-value">{{newStartTime}} â€”â€” {{newEndTime}}</text>
          </view>
        </view>
        
        <view class="confirm-section">
          <text class="section-title">è´¹ç”¨æ˜ç»†</text>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§Ÿå•ä»·ï¼š</text>
            <text class="confirm-value">Â¥{{currentRenewPrice}}/å¤©</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§Ÿå°è®¡ï¼š</text>
            <text class="confirm-value">Â¥{{renewSubtotal}}</text>
          </view>
          <view class="confirm-row" wx:if="{{purchaseMembership && membershipFee > 0}}">
            <text class="confirm-label">ä¼šå‘˜è´¹ç”¨ï¼š</text>
            <text class="confirm-value">Â¥{{membershipFee}}</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">ç³»ç»ŸæœåŠ¡è´¹ï¼š</text>
            <text class="confirm-value">Â¥{{serviceFee}}</text>
          </view>
          <view class="confirm-row total-confirm">
            <text class="confirm-label">æ”¯ä»˜é‡‘é¢ï¼š</text>
            <text class="confirm-value highlight">Â¥{{totalAmount}}</text>
          </view>
        </view>
      </view>
      <view class="modal-buttons">
        <button class="cancel-btn" bindtap="hidePaymentModal">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="confirmPayment">ç¡®è®¤åˆ›å»ºå¹¶æ”¯ä»˜</button>
      </view>
    </view>
  </view>
</view>