<!-- renewal-car.wxml - æŒ‰ç…§è®¢å•é¡µé¢æ¨¡å¼ä¿®æ”¹çš„ç»­ç§Ÿé¡µé¢æ¨¡æ¿ -->
<view class="renew-container">
  
  <!-- åŸè®¢å•ä¿¡æ¯å¡ç‰‡ - æŒ‰ç…§è®¢å•é¡µé¢æ ·å¼ -->
  <view class="order-card">
    <view class="info-header">
      <text class="info-title">åŸè®¢å•ä¿¡æ¯</text>
      <text class="order-status completed">å·²å®Œæˆ</text>
    </view>
    
    <!-- è½¦è¾†ä¿¡æ¯ -->
    <view class="car-info">
      <view class="car-name">{{originalOrderInfo.carModel}}</view>
      <image class="car-image" src="{{originalOrderInfo.carImage}}" mode="aspectFit"></image>
    </view>
    
    <!-- é—¨åº—ä¿¡æ¯ -->
    <view class="store-info">
      <view class="store-point orange"></view>
      <view class="store-name">{{originalOrderInfo.pickupStore}}</view>
    </view>
    <view class="store-info">
      <view class="store-point green"></view>
      <view class="store-name">{{originalOrderInfo.returnStore}}</view>
    </view>
    
    <!-- ç§Ÿèµæ—¶é—´ -->
    <view class="rental-time">
      <view class="time-info">{{originalStartTimeText}}</view>
      <view class="time-info">â€”</view>
      <view class="day-count">{{originalOrderInfo.totalRentalDays}}å¤©</view>
      <view class="time-info">â€”</view>
      <view class="time-info">{{originalEndTimeText}}</view>
    </view>
    
    <!-- è®¢å•é“¾æŠ˜å åŒºåŸŸ - å¦‚æœæœ‰è®¢å•é“¾åˆ™æ˜¾ç¤º -->
    <view class="order-chain-section" wx:if="{{showOrderChain}}">
      <!-- æŠ˜å å¤´éƒ¨ -->
      <view class="chain-header" bindtap="toggleOrderChain">
        <view class="chain-info">
          <text class="chain-icon">ğŸ”—</text>
          <text class="chain-title">è®¢å•é“¾è¯¦æƒ… ({{chainSummary.totalOrders}}ä¸ªè®¢å•)</text>
          <!-- ä½¿ç”¨é¢„è®¡ç®—çš„æ ‡ç­¾ -->
          <view wx:for="{{chainSummary.badges}}" wx:key="type" class="{{item.type}}-badge">
            {{item.text}}
          </view>
        </view>
        <view class="chain-arrow {{isChainExpanded ? 'expanded' : ''}}">
          â–¼
        </view>
      </view>
      
      <!-- æŠ˜å å†…å®¹ -->
      <view class="chain-content" wx:if="{{isChainExpanded}}">
        
        <!-- è®¢å•é“¾æ¡åˆ—è¡¨ -->
        <view wx:for="{{processedChainDetails}}" wx:key="orderId" wx:for-item="chainItem" class="chain-item">
          
          <!-- è®¢å•ç±»å‹å’ŒçŠ¶æ€ -->
          <view class="chain-item-header">
            <view class="order-type-tag {{chainItem.typeClassName}}">
              {{chainItem.orderType}}
            </view>
            <view class="order-status-tag {{chainItem.statusClassName}}">
              {{chainItem.orderStatus}}
            </view>
          </view>
          
          <!-- è®¢å•è¯¦ç»†ä¿¡æ¯ -->
          <view class="chain-item-body">
            <view class="detail-row">
              <text class="detail-label">è®¢å•ç¼–å·:</text>
              <text class="detail-value">{{chainItem.orderId}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">è®¢å•ä»·æ ¼:</text>
              <text class="detail-value price-value">{{chainItem.formattedPrice}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">ç”Ÿæ•ˆæ—¶é—´:</text>
              <text class="detail-value">{{chainItem.formattedEffectiveTime}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">ç§ŸæœŸå¤©æ•°:</text>
              <text class="detail-value">{{chainItem.rentalDays}}å¤©</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">åˆ›å»ºæ—¶é—´:</text>
              <text class="detail-value">{{chainItem.formattedCreateTime}}</text>
            </view>
            
            <!-- è¶…æ—¶ä¿¡æ¯ -->
            <block wx:if="{{chainItem.showOvertimeInfo}}">
              <view class="detail-row overtime-row">
                <text class="detail-label">è¶…æ—¶æƒ…å†µ:</text>
                <text class="detail-value overtime-text">è¶…æ—¶{{chainItem.overtimeHours}}å°æ—¶</text>
              </view>
              <view class="detail-row" wx:if="{{chainItem.actualEndTime}}">
                <text class="detail-label">å®é™…è¿˜è½¦:</text>
                <text class="detail-value">{{chainItem.actualEndTime}}</text>
              </view>
              <view class="detail-row" wx:if="{{chainItem.formattedOvertimeFee}}">
                <text class="detail-label">è¶…æ—¶è´¹ç”¨:</text>
                <text class="detail-value overtime-fee">{{chainItem.formattedOvertimeFee}}</text>
              </view>
              <!-- è¡¥ç¼´è®¢å•æ ‡è¯† -->
              <view class="payment-notice" wx:if="{{chainItem.showPaymentNotice}}">
                <text class="notice-icon">ğŸ’°</text>
                <text class="notice-text">æ­¤è®¢å•éœ€è¦è¡¥ç¼´è¶…æ—¶è´¹ç”¨</text>
              </view>
            </block>
          </view>
        </view>
        
        <!-- å‡ºè½¦è®°å½•ä¿¡æ¯ -->
        <view class="vehicle-record">
          <view class="record-header">
            <text class="record-icon">ğŸš—</text>
            <text class="record-title">å‡ºè½¦è®°å½•ä¿¡æ¯</text>
          </view>
          <view class="record-content">
            <view class="record-row">
              <text class="record-label">è®°å½•ç¼–å·:</text>
              <text class="record-value">{{originalOrderInfo.vehicleRecordId}}</text>
            </view>
            <view class="record-row">
              <text class="record-label">è½¦è¾†ç¼–å·:</text>
              <text class="record-value">{{originalOrderInfo.carNumber}}</text>
            </view>
            <view class="record-row">
              <text class="record-label">æ€»ç§ŸæœŸ:</text>
              <text class="record-value">{{originalOrderInfo.totalRentalDays}}å¤©</text>
            </view>
            <view class="record-row">
              <text class="record-label">ç»­ç§Ÿæ¬¡æ•°:</text>
              <text class="record-value">{{originalOrderInfo.renewalCount}}æ¬¡</text>
            </view>
            <view class="record-row">
              <text class="record-label">å–è½¦æ—¶é—´:</text>
              <text class="record-value">{{originalStartTimeText}}</text>
            </view>
            <view class="record-row">
              <text class="record-label">è¿˜è½¦æ—¶é—´:</text>
              <text class="record-value">{{originalEndTimeText}}</text>
            </view>
            <view class="record-row" wx:if="{{originalOrderInfo.hasPayment}}">
              <text class="record-label">è¡¥ç¼´çŠ¶æ€:</text>
              <text class="record-value payment-status">å­˜åœ¨è¶…æ—¶è¡¥ç¼´è´¹ç”¨</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åŸºæœ¬è®¢å•ä¿¡æ¯ -->
    <view class="basic-info">
      <view class="info-row">
        <text class="info-label">è®¢å•ç¼–å·:</text>
        <text class="info-value">{{originalOrderInfo.orderId}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">ç®¡ç†å‘˜:</text>
        <text class="info-value">{{originalOrderInfo.managerName}}</text>
        <text class="phone-link" bindtap="makePhoneCall" data-phone="{{originalOrderInfo.managerPhone}}">{{originalOrderInfo.managerPhone}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">å‡ºè½¦è®°å½•:</text>
        <text class="info-value">{{originalOrderInfo.vehicleRecordId}}</text>
      </view>
    </view>
  </view>

  <!-- ä¼šå‘˜è´­ä¹°å¡ç‰‡ -->
  <view class="member-card" wx:if="{{showMemberCard}}">
    <view class="info-header">
      <text class="info-title">ä¼šå‘˜ç‰¹æƒ</text>
    </view>
    <view class="member-content">
      <view class="member-benefits">
        <view class="benefit-item">
          <text class="benefit-icon">ğŸ‰</text>
          <text class="benefit-text">ç»­ç§Ÿäº«å—{{membershipInfo.discountText}}ä¼˜æƒ </text>
        </view>
        <view class="benefit-item">
          <text class="benefit-icon">âš¡</text>
          <text class="benefit-text">ä¸“å±å®¢æœä¼˜å…ˆæœåŠ¡</text>
        </view>
        <view class="benefit-item">
          <text class="benefit-icon">ğŸ”§</text>
          <text class="benefit-text">å…è´¹è®¾å¤‡æ£€æµ‹æœåŠ¡</text>
        </view>
      </view>
      <view class="member-purchase">
        <view class="purchase-option">
          <checkbox-group bindchange="onPurchaseMembershipChange">
            <label class="checkbox-label">
              <checkbox value="purchase" checked="{{purchaseMembership}}" color="#ff7200"/>
              <text class="purchase-text">è´­ä¹°ä¼šå‘˜</text>
              <text class="member-price">Â¥{{membershipInfo.price}}</text>
            </label>
          </checkbox-group>
        </view>
        <view class="member-tip">
          <text class="tip-text">æœ¬æ¬¡ç»­ç§Ÿç«‹å³äº«å—ä¼šå‘˜ä»·æ ¼</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç»­ç§Ÿè®¾ç½® -->
  <view class="renew-section">
    <view class="info-header">
      <text class="info-title">æ–°ç»­ç§Ÿè®¢å•è®¾ç½®</text>
    </view>
    
    <!-- æ–°è®¢å•ä¿¡æ¯é¢„è§ˆ -->
    <view class="new-order-preview">
      <view class="preview-row">
        <text class="preview-label">æ–°è®¢å•ç¼–å·:</text>
        <text class="preview-value">{{renewalOrderInfo.orderId}}</text>
      </view>
      <view class="preview-row">
        <text class="preview-label">å…³è”åŸè®¢å•:</text>
        <text class="preview-value">{{renewalOrderInfo.parentOrderId}}</text>
      </view>
      <view class="preview-row">
        <text class="preview-label">ç»­ç§Ÿå±‚çº§:</text>
        <text class="preview-value">ç¬¬{{renewalOrderInfo.renewalLevel}}æ¬¡ç»­ç§Ÿ</text>
      </view>
      <view class="preview-row">
        <text class="preview-label">å‡ºè½¦è®°å½•:</text>
        <text class="preview-value">{{originalOrderInfo.vehicleRecordId}} (å…±äº«)</text>
      </view>
    </view>
    
    <view class="renew-input-row">
      <text class="input-label">ç»­ç§Ÿå¤©æ•°:</text>
      <input 
        class="day-input" 
        type="number" 
        placeholder="è¯·è¾“å…¥ç»­ç§Ÿå¤©æ•°"
        value="{{renewDays}}"
        bindinput="onRenewDaysChange"
        bindblur="onRenewDaysBlur"
        min="1"
      />
      <text class="input-unit">å¤©</text>
    </view>
    <view class="input-tip">*æœ€å°‘ç»­ç§Ÿ1å¤©ï¼Œç»­ç§Ÿè®¢å•å°†åœ¨åŸè®¢å•ç»“æŸåè‡ªåŠ¨ç”Ÿæ•ˆ</view>
    <view class="error-tip" wx:if="{{daysErrorTip}}">
      <text class="error-text">{{daysErrorTip}}</text>
    </view>
    
    <!-- æ–°ç§ŸæœŸæ˜¾ç¤º -->
    <view class="new-period" wx:if="{{showNewPeriod}}">
      <view class="period-header">
        <text class="period-title">æ–°ç»­ç§Ÿè®¢å•ç§ŸæœŸ</text>
        <text class="period-status">å¾…ç”Ÿæ•ˆ</text>
      </view>
      <view class="period-display">
        <text class="period-text">{{newStartTime}} â€”â€” {{newEndTime}}</text>
        <text class="period-days">(ç»­ç§Ÿ{{renewDays}}å¤©)</text>
      </view>
      <view class="period-note">
        <text class="note-text">æ³¨ï¼šç»­ç§Ÿè®¢å•å°†åœ¨{{originalEndTimeText}}åŸè®¢å•ç»“æŸåç«‹å³ç”Ÿæ•ˆ</text>
      </view>
    </view>
  </view>

  <!-- æ”¯ä»˜æ˜ç»† -->
  <view class="payment-detail" wx:if="{{showPaymentDetail}}">
    <view class="info-header">
      <text class="info-title">æ”¯ä»˜æ˜ç»† (æ–°ç»­ç§Ÿè®¢å•)</text>
    </view>
    <view class="detail-row">
      <text class="detail-label">ç»­ç§Ÿå¤©æ•°:</text>
      <text class="detail-value">{{renewDays}}å¤©</text>
    </view>
    <view class="detail-row">
      <text class="detail-label">ç»­ç§Ÿå•ä»·:</text>
      <text class="detail-value">
        Â¥{{currentRenewPrice}}/å¤©
        <text class="original-price" wx:if="{{(isMember || purchaseMembership) && currentRenewPrice != renewPrice}}">
          åŸä»·Â¥{{renewPrice}}
        </text>
      </text>
    </view>
    <view class="detail-row">
      <text class="detail-label">ç»­ç§Ÿå°è®¡:</text>
      <text class="detail-value">Â¥{{renewSubtotal}}</text>
    </view>
    
    <!-- ä¼šå‘˜è´¹ç”¨ -->
    <view class="detail-row" wx:if="{{purchaseMembership && membershipFee > 0}}">
      <text class="detail-label">ä¼šå‘˜è´¹ç”¨:</text>
      <text class="detail-value member-fee">Â¥{{membershipFee}}</text>
    </view>
    
    <view class="detail-row subtotal-row">
      <text class="detail-label">æœåŠ¡è´¹å‰å°è®¡:</text>
      <text class="detail-value">Â¥{{serviceSubtotal}}</text>
    </view>
    
    <!-- ç³»ç»ŸæœåŠ¡è´¹ -->
    <view class="detail-row">
      <text class="detail-label">ç³»ç»ŸæœåŠ¡è´¹({{serviceRatePercent}}%):</text>
      <text class="detail-value service-fee">Â¥{{serviceFee}}</text>
    </view>
    
    <view class="detail-row total-row">
      <text class="detail-label">æ€»è®¡:</text>
      <text class="detail-value total-price">Â¥{{totalAmount}}</text>
    </view>
    
    <!-- è®¢å•åˆ›å»ºè¯´æ˜ -->
    <view class="payment-note">
      <view class="note-header">ğŸ“‹ è®¢å•åˆ›å»ºè¯´æ˜</view>
      <view class="note-content">
        <text class="note-item">â€¢ æ”¯ä»˜æˆåŠŸåå°†ç«‹å³åˆ›å»ºæ–°çš„ç»­ç§Ÿè®¢å•</text>
        <text class="note-item">â€¢ ç»­ç§Ÿè®¢å•çŠ¶æ€ä¸º"å¾…ç”Ÿæ•ˆ"ï¼Œåœ¨åŸè®¢å•ç»“æŸåè‡ªåŠ¨ç”Ÿæ•ˆ</text>
        <text class="note-item">â€¢ æ–°è®¢å•ä¸åŸè®¢å•å…±äº«åŒä¸€å‡ºè½¦è®°å½•ï¼Œè½¦è¾†æ— éœ€é‡æ–°å–è½¦</text>
        <text class="note-item">â€¢ ç»­ç§Ÿè®¢å•å¯ä»¥ç»§ç»­è¿›è¡Œç»­ç§Ÿæˆ–è¿˜è½¦æ“ä½œ</text>
        <text class="note-item">â€¢ æ–°è®¢å•å°†æ·»åŠ åˆ°åŸè®¢å•çš„è®¢å•é“¾ä¸­ï¼Œå¯åœ¨è®¢å•åˆ—è¡¨æŸ¥çœ‹</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ”¯ä»˜åŒºåŸŸ -->
  <view class="payment-section">
    <view class="payment-left">
      <text class="payment-label">åˆ›å»ºç»­ç§Ÿè®¢å•å¹¶æ”¯ä»˜:</text>
      <text class="payment-amount">Â¥{{totalAmount || '0.00'}}</text>
    </view>
    <button class="payment-btn" bindtap="submitPayment" disabled="{{!canPay}}">
      {{paymentButtonText}}
    </button>
  </view>
</view>

<!-- æ”¯ä»˜ç¡®è®¤å¼¹çª— -->
<view class="modal-mask" wx:if="{{showPaymentModal}}" bindtap="hidePaymentModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç¡®è®¤åˆ›å»ºç»­ç§Ÿè®¢å•</text>
      <text class="modal-close" bindtap="hidePaymentModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="confirm-detail">
        <view class="confirm-section">
          <text class="section-title">ç»­ç§Ÿè®¢å•ä¿¡æ¯</text>
          <view class="confirm-row">
            <text class="confirm-label">æ–°è®¢å•ç¼–å·:</text>
            <text class="confirm-value">{{renewalOrderInfo.orderId}}</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">å…³è”åŸè®¢å•:</text>
            <text class="confirm-value">{{renewalOrderInfo.parentOrderId}}</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§Ÿå±‚çº§:</text>
            <text class="confirm-value">ç¬¬{{renewalOrderInfo.renewalLevel}}æ¬¡ç»­ç§Ÿ</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">è®¢å•çŠ¶æ€:</text>
            <text class="confirm-value">å¾…ç”Ÿæ•ˆ (åŸè®¢å•ç»“æŸåè‡ªåŠ¨ç”Ÿæ•ˆ)</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">å‡ºè½¦è®°å½•:</text>
            <text class="confirm-value">{{originalOrderInfo.vehicleRecordId}} (å…±äº«)</text>
          </view>
        </view>
        
        <view class="confirm-section">
          <text class="section-title">ç§ŸæœŸä¿¡æ¯</text>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§Ÿå¤©æ•°:</text>
            <text class="confirm-value">{{renewDays}}å¤©</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§ŸæœŸé—´:</text>
            <text class="confirm-value">{{newStartTime}} â€”â€” {{newEndTime}}</text>
          </view>
        </view>
        
        <view class="confirm-section">
          <text class="section-title">è´¹ç”¨æ˜ç»†</text>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§Ÿå•ä»·:</text>
            <text class="confirm-value">Â¥{{currentRenewPrice}}/å¤©</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">ç»­ç§Ÿå°è®¡:</text>
            <text class="confirm-value">Â¥{{renewSubtotal}}</text>
          </view>
          <view class="confirm-row" wx:if="{{purchaseMembership && membershipFee > 0}}">
            <text class="confirm-label">ä¼šå‘˜è´¹ç”¨:</text>
            <text class="confirm-value">Â¥{{membershipFee}}</text>
          </view>
          <view class="confirm-row">
            <text class="confirm-label">ç³»ç»ŸæœåŠ¡è´¹:</text>
            <text class="confirm-value">Â¥{{serviceFee}}</text>
          </view>
          <view class="confirm-row total-confirm">
            <text class="confirm-label">æ”¯ä»˜é‡‘é¢:</text>
            <text class="confirm-value highlight">Â¥{{totalAmount}}</text>
          </view>
        </view>
      </view>
      <view class="modal-buttons">
        <button class="cancel-btn" bindtap="hidePaymentModal">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="confirmPayment">ç¡®è®¤åˆ›å»ºå¹¶æ”¯ä»˜</button>
      </view>
    </view>
  </view>
</view>